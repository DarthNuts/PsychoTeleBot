# PsychoTeleBot

Telegram-–±–æ—Ç –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å –æ—Ñ–ª–∞–π–Ω-–æ—Ç–ª–∞–¥–∫–æ–π (Clean Architecture).

## –û–ø–∏—Å–∞–Ω–∏–µ

PsychoTeleBot ‚Äî —ç—Ç–æ –±–æ—Ç –¥–ª—è Telegram, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ Clean Architecture, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É **–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Telegram API**.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üè† **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é** —Å –≤—ã–±–æ—Ä–æ–º –¥–µ–π—Å—Ç–≤–∏–π
- üë®‚Äç‚öïÔ∏è **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ —Å –ø–æ–ª–Ω–æ–π —Ñ–æ—Ä–º–æ–π
- ü§ñ **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –ò–ò** ‚Äî —á–∞—Ç —Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º (–∑–∞–≥–ª—É—à–∫–∞)
- üìã **–£—Å–ª–æ–≤–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è** ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
- ‚ùì **–í–æ–ø—Ä–æ—Å –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏** ‚Äî –±—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- üîÑ **–ö–æ–º–∞–Ω–¥–∞ /menu** ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é –∏–∑ –ª—é–±–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- üóëÔ∏è **–ö–æ–º–∞–Ω–¥–∞ /clear** ‚Äî –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ò–ò-—á–∞—Ç–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Clean Architecture:

```
PsychoTeleBot/
‚îú‚îÄ‚îÄ domain/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ models.py        # –î–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (State, Ticket, UserSession)
‚îÇ   ‚îî‚îÄ‚îÄ repositories.py  # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îú‚îÄ‚îÄ application/         # Use cases –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ state_machine.py # State Machine –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ bot_service.py   # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –±–æ—Ç–∞
‚îú‚îÄ‚îÄ infrastructure/      # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îÇ   ‚îî‚îÄ‚îÄ in_memory_repositories.py
‚îú‚îÄ‚îÄ adapters/            # –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–∏—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ cli/             # CLI –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
‚îÇ       ‚îú‚îÄ‚îÄ __main__.py
‚îÇ       ‚îî‚îÄ‚îÄ runner.py
‚îî‚îÄ‚îÄ tests/               # –¢–µ—Å—Ç—ã
    ‚îú‚îÄ‚îÄ test_models.py
    ‚îú‚îÄ‚îÄ test_state_machine.py
    ‚îî‚îÄ‚îÄ test_bot_service.py
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
```bash
git clone <repository_url>
cd PsychoTeleBot
```

2. –°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
```bash
python -m venv venv
```

3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
- Windows:
  ```bash
  venv\Scripts\activate
  ```
- Linux/Mac:
  ```bash
  source venv/bin/activate
  ```

4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### CLI Debug Mode (–æ—Ñ–ª–∞–π–Ω-–æ—Ç–ª–∞–¥–∫–∞)

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –±–µ–∑ Telegram API –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CLI:

```bash
python -m adapters.cli
```

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã CLI:
- `/start` ‚Äî –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥
- `/menu` ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é
- `/clear` ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ò–ò (–≤ —Ä–µ–∂–∏–º–µ AI_CHAT)
- `/reset` ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/user <id>` ‚Äî —Å–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/tickets` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏
- `/quit` ‚Äî –≤—ã—Ö–æ–¥ –∏–∑ CLI

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CLI:

```
============================================================
  PsychoTeleBot - CLI Debug Mode
============================================================

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  /start - –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥
  /menu - –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é
  /clear - –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ò–ò
  /reset - —Å–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é
  /user <id> - —Å–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  /tickets - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏
  /quit - –≤—ã—Ö–æ–¥
============================================================

ü§ñ –ë–æ—Ç:
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PsychoTeleBot!

–Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø–æ–ª—É—á–∏—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É.

üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
1Ô∏è‚É£ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
2Ô∏è‚É£ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –ò–ò
3Ô∏è‚É£ –£—Å–ª–æ–≤–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è
4Ô∏è‚É£ –í–æ–ø—Ä–æ—Å –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏

[test_user_1] > 1
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:

```bash
pytest
```

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º:

```bash
pytest -v
```

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:

```bash
pytest tests/test_bot_service.py::test_consultation_full_flow -v
```

## State Machine

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç (State Machine) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏:

### –°–æ—Å—Ç–æ—è–Ω–∏—è:
- `MENU` ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- `CONSULT_FORM_TOPIC` ‚Äî –≤–≤–æ–¥ —Ç–µ–º—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
- `CONSULT_FORM_GENDER` ‚Äî –≤–≤–æ–¥ –ø–æ–ª–∞
- `CONSULT_FORM_AGE` ‚Äî –≤–≤–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç–∞
- `CONSULT_FORM_SEVERITY` ‚Äî –≤—ã–±–æ—Ä –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
- `CONSULT_FORM_MESSAGE` ‚Äî –≤–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
- `AI_CHAT` ‚Äî —á–∞—Ç —Å –ò–ò
- `TERMS` ‚Äî —É—Å–ª–æ–≤–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è
- `PSY_QUESTION` ‚Äî –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏

### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `/menu` ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –º–µ–Ω—é
- `/clear` ‚Äî –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `AI_CHAT`

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### UserSession
–•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- `user_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `state` ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `consultation_form` ‚Äî –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
- `ai_context` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ —Å –ò–ò
- `current_ticket_id` ‚Äî ID —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏

### Ticket
–ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:
- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
- `user_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `topic` ‚Äî —Ç–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
- `gender` ‚Äî –ø–æ–ª
- `age` ‚Äî –≤–æ–∑—Ä–∞—Å—Ç
- `severity` ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å (LOW, MEDIUM, HIGH, CRITICAL)
- `message` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ
- `status` ‚Äî —Å—Ç–∞—Ç—É—Å (NEW, IN_PROGRESS, WAITING_RESPONSE, CLOSED)
- `assigned_to` ‚Äî –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç
- `chat_history` ‚Äî –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Telegram –∞–¥–∞–ø—Ç–µ—Ä–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `adapters/telegram/`
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram Bot API
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `BotService` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:

```python
from application.bot_service import BotService
from application.state_machine import StateMachine
from infrastructure.in_memory_repositories import (
    InMemorySessionRepository, InMemoryTicketRepository
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
session_repo = InMemorySessionRepository()
ticket_repo = InMemoryTicketRepository()
state_machine = StateMachine()
bot_service = BotService(session_repo, ticket_repo, state_machine)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
response = bot_service.process_message(user_id, message_text)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

1. –†–µ–∞–ª–∏–∑—É–π—Ç–µ `SessionRepository` –∏ `TicketRepository` –¥–ª—è –≤–∞—à–µ–π –ë–î
2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –≤ `infrastructure/` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `sqlite_repositories.py`)
3. –ó–∞–º–µ–Ω–∏—Ç–µ `InMemoryRepositories` –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å –ë–î

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏:
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã –º–æ–¥–µ–ª–µ–π
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã State Machine
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã BotService
- ‚úÖ End-to-end —Ç–µ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

–í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç **–æ—Ñ–ª–∞–π–Ω**, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ê–≤—Ç–æ—Ä—ã

PsychoTeleBot Team
